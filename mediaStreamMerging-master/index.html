<html>

<head>
  <title>PeerJS - Video chat example</title>
  <link rel="stylesheet" href="style.css">
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script type="text/javascript" src="https://skyway.io/dist/0.3/peer.js"></script>

  <script type="text/javascript" src="delay.js"></script>
  <script type="text/javascript" src="speechjammer.js"></script>
  <script type="text/javascript" src="pichshift.js"></script>
  <script src="Stats.js"></script>
  <script src="clmtrackr.min.js"></script>
  <script src="model_pca_20_svm.js"></script>
  <script src="svmfilter_webgl.js"></script>
  <script src="face_deformer.js"></script>

  <table>
    <tr>
      <td>SpeechJammer :</td>
      <td><input id="speechjammer" type="checkbox" checked="true" /></td>
    </tr>
    <tr>
      <td>Bypass :</td>
      <td><input id="bypass" type="checkbox" /></td>
    </tr>
    <tr>
      <td>Time : </td>
      <td><input type="text" size="8" id="time" value="0.25" /></td>
    </tr>
    <tr>
      <td>Feedback : </td>
      <td><input type="text" size="8" id="feedback" value="0.4" /></td>
    </tr>
    <tr>
      <td>Mix : </td>
      <td><input type="text" size="8" id="mix" value="0.4" /></td>
    </tr>
    <tr>
      <td>SendBt :</td>
      <td><input id="sendBt" type="checkbox" checked="true" /></td>
    </tr </table>


    <script>
      // Compatibility shim
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

      // PeerJS object
      var peer = new Peer({
        key: '26b7f1a7-ea54-42e9-872a-f3bb803d816b',
        debug: 3
      });



      peer.on('open', function() {
        $('#my-id').text(peer.id);
      });



      // Receiving a call
      peer.on('call', function(call) {
        // Answer the call automatically (instead of prompting user) for demo purposes
        call.answer(window.localStream);
        step3(call);
      });
      peer.on('error', function(err) {
        alert(err.message);
        // Return to step 2 if error occurs
        step2();
      });

      // Click handlers setup
      $(function() {
        $('#make-call').click(function() {
          // Initiate a call!
          var call = peer.call($('#callto-id').val(), window.localStream);

          step3(call);
        });

        $('#end-call').click(function() {
          window.existingCall.close();
          step2();
        });

        // Retry if getUserMedia fails
        $('#step1-retry').click(function() {
          $('#step1-error').hide();
          step1();
        });

        // Get things started
        step1();
      });

      function step1() {
        // 顔のワイヤーフレームが表示されるcanvasタグ
        var wireframe = document.getElementById("wireframe");
        var wireframeContext = wireframe.getContext("2d");
        // マスクを描画するcanvas
        var maskCanvas;
        // video
        var video = document.getElementById("video");

        // ログ表示用
        var log = document.getElementById("log");
        // マスク画像
        var maskUrl = "mozaiku.png";
        // マスクの頂点データ
        var maskData = [
          [266.539778613571, 254.84378898872825],
          [266.3039097561577, 285.302233189556],
          [271.19357329466345, 316.3538789507933],
          [278.7139543521674, 345.15573844972926],
          [293.15712497356776, 368.9809024015706],
          [312.64193974141324, 389.09850232246515],
          [322.13343587641253, 398.3663601209212],
          [336.9858985066435, 401.49456958745145],
          [356.87519225850986, 398.5376499254816],
          [382.97232156668036, 391.79752653535775],
          [421.61286401088506, 373.50434543677886],
          [448.74322775690695, 344.0259953810623],
          [464.77440099078314, 310.71915538180275],
          [468.2775933241595, 272.2241198406615],
          [466.74514645738424, 247.20492682906303],
          [415.26964981149064, 225.8370550250565],
          [390.13712322351404, 222],
          [361.92175039938184, 220.2582273389706],
          [342.2734356138508, 232.04834635926073],
          [267.7624903928149, 236.00873885152805],
          [280.88607721372824, 229],
          [303.9033677258633, 228],
          [316.6965360192193, 234.20369314639848],
          [281.57998031880885, 254.77971856631495],
          [298.953459306752, 246.21641370334032],
          [315.75345517431316, 254.4516165242651],
          [296.6631361379687, 258.36486568494297],
          [301.63327656416925, 252.0239926097512],
          [398.27491865673994, 249.8954346966754],
          [380.22403819342355, 243.83584281695727],
          [357.98660716766716, 253.53119540181672],
          [378.25469629277825, 255.99515336941278],
          [382.6139465907322, 249.6433274231842],
          [328, 253],
          [314.73794539936216, 301.757722929817],
          [309.85213116736014, 314.6797549304112],
          [313.1507370768973, 321.4994076914073],
          [325.20473159190635, 327.87953636258146],
          [350.1231795924951, 324.5425216268138],
          [358.3783946629097, 316.6717252774034],
          [352.7986254362873, 299.5519517987678],
          [326, 282],
          [314.75674487301336, 318.32005216616164],
          [343.0322275619273, 319.2819917007706],
          [307.87514392633693, 346.0346979532304],
          [316.68926117981914, 342.91320569661593],
          [321.7320399187087, 341.45780089974846],
          [327.8558316510405, 343.56649844038935],
          [336.18423231506125, 341.74737597014604],
          [351.00603891713007, 342.2560527375472],
          [367.88222498993025, 344.3660717427479],
          [357.305053617142, 354.4583428810625],
          [343.5761668856892, 358.8848818975423],
          [328.82001419900075, 359.1051832365163],
          [320.36190636746045, 358.71759346010083],
          [312.61714975606304, 353.5625007817836],
          [318.4988566294063, 348.1744254793423],
          [328.6406599928464, 349.73460503451736],
          [350.2480353796336, 349.6831133201238],
          [349.5754234743516, 349.5362145583936],
          [329.32557946752445, 349.67345155068153],
          [318.2253756678819, 347.9222277142419],
          [324.4964277572599, 315.63122813643895],
          [288.26630901657126, 248.99890899333045],
          [309.3536455351319, 248.83485523505226],
          [307.7075352919804, 256.40978560947974],
          [288.62032608071166, 258.5736833679789],
          [390.2498028902113, 244.8663932568382],
          [368.1047796233772, 247.18427292360775],
          [368.62079313091925, 255.76448975973483],
          [390.7655312307384, 254.4464699123733]
        ];
        // マスクを描画するクラス
        var fd;
        // clmtrackr
        var ctrack;

        // (1) まずはビデオのみのストリームを取り出す
        navigator.getUserMedia({
            audio: false,
            video: true
          },
          function(videoStream) {
            // Set your video displays
            $('#my-video').prop('src', URL.createObjectURL(videoStream));
            window.localStream = videoStream;

            // videoのメタデータの取得が成功
            video.addEventListener("loadedmetadata", function(event) {
              drowLog("顔検出中...");
              // videoのサイズを取得
              var videoW = video.clientWidth;
              var videoH = video.clientHeight;

              // マスク用のcanvasを生成
              maskCanvas = document.createElement("canvas");
              maskCanvas.setAttribute("id", "mask");

              // サイズを設定
              video.width = wireframe.width = maskCanvas.width = videoW;
              video.height = wireframe.height = maskCanvas.height = videoH;

              // マスク用canvasを配置
              document.getElementById("drawArea").appendChild(maskCanvas);

              setTimeout(function() {
                // clmtrackrをインスタンス化
                ctrack = new clm.tracker();
                // 顔のモデルデータを設定
                ctrack.init(pModel);

                // マスクを描画するクラスをインスタンス化
                fd = new faceDeformer();
                // マスクを描画するcanvasを指定
                fd.init(maskCanvas);

                // マスク用画像の読み込み
                var img = document.createElement("img");
                img.onload = function() {
                  // マスクの設定
                  fd.load(img, maskData, pModel);
                };
                img.src = maskUrl;

                // 繰り返し処理開始
                loop();

                // 顔を検出できたときのEvent
                document.addEventListener("clmtrackrConverged", clmtrackrConvergedHandler);
                // 顔を検出できなかったときのEvent
                document.addEventListener("clmtrackrLost", clmtrackrLostHandler);
                // 顔の検出を開始
                ctrack.start(video);
              }, 1000);
            });

            // videoでWebカメラの映像を表示
            video.src = URL.createObjectURL(mediaStream);
            // (2) 次に、音声のみのストリームを取り出す
            navigator.getUserMedia({
                audio: true,
                video: false
              },
              function(audioStream) {

                SpeechJammer.setupSJ(audioStream);
                PichShift.setup(audioStream);

                // できあがったoutputをvideoStreamに合流させる
                videoStream.addTrack(PichShift.output.stream.getAudioTracks()[0]);

                step2();
              },
              function() {
                $('#step1-error').show();　
              } //エラー表示
            );
          },
          function() {
            $('#step1-error').show();　
          } //エラー表示
        );
      }
      /**
       * 繰り返し処理
       */
      function loop() {
        // Stats計測開始
        stats.begin();

        // canvasの描画をクリア
        wireframeContext.clearRect(0, 0, wireframe.width, wireframe.height);

        // 座標が取得できたかどうか
        if (ctrack.getCurrentPosition()) {
          // ワイヤーフレームを描画
          ctrack.draw(wireframe);
        }

        // マスクを適応する範囲が決まってきたかどうか
        var pn = ctrack.getConvergence();
        if (pn < 0.4) {
          requestAnimationFrame(drawMaskLoop);
        } else {
          requestAnimationFrame(loop);
        }

        // Stats計測終了
        stats.end();
      }

      /**
       * マスク描画用の繰り返し処理
       */
      function drawMaskLoop() {
        // requestAnimationFrame
        requestAnimationFrame(drawMaskLoop);

        // canvasの描画をクリア
        wireframeContext.clearRect(0, 0, wireframe.width, wireframe.height);

        // 座標を取得
        var positions = ctrack.getCurrentPosition();
        if (positions) {
          // マスクを描画
          fd.draw(positions);
        }
      }

      /**
       * 顔検出失敗
       */
      function clmtrackrLostHandler() {
        // Remove Event
        document.removeEventListener("clmtrackrLost", clmtrackrLostHandler);
        document.removeEventListener("clmtrackrConverged", clmtrackrConvergedHandler);

        drowLog("顔検出失敗");
      }

      /**
       * 顔検出成功
       */
      function clmtrackrConvergedHandler() {
        // Remove Event
        document.removeEventListener("clmtrackrLost", clmtrackrLostHandler);
        document.removeEventListener("clmtrackrConverged", clmtrackrConvergedHandler);

        drowLog("顔検出成功");
      }

      /**
       * ログを表示
       * @param str
       */
      function drowLog(str) {
        log.innerHTML = str;
      }

      function step2() {
        $('#step1, #step3').hide();
        $('#step2').show();
      }

      function step3(call) {
        // Hang up on an existing call if present
        if (window.existingCall) {
          window.existingCall.close();
        }

        // Wait for stream on the call, then set peer video display
        call.on('stream', function(stream) {
          $('#their-video').prop('src', URL.createObjectURL(stream));
        });

        // UI stuff
        window.existingCall = call;
        $('#their-id').text(call.peer);
        call.on('close', step2);
        $('#step1, #step2').hide();
        $('#step3').show();
      }
    </script>

</head>

<body>

  <form name="selbox">
    <p>music:<br>
      <select id="music">
  <option value="./cafe.mp3">cafe</option>
  <option value="./sea.mp3">sea</option>
  <option value="./work.mp3">work</option>
  <option value="./party.mp3">party</option>
  </select></p>
  </form>
  <button id="playsound" disabled>Play</button><br/>

  <div class="pure-g">

    <!-- Video area -->
    <div class="pure-u-2-3" id="video-container">
      <video id="their-video" autoplay></video>
      <video id="my-video" muted="true" autoplay></video>

    </div>
  </div>

  <!-- Steps -->
  <div class="pure-u-1-3">
    <h2>PeerJS Video Chat</h2>

    <!-- Get local audio/video stream -->
    <div id="step1">
      <p>Please click `allow` on the top of the screen so we can access your webcam and microphone for calls.</p>
      <div id="step1-error">
        <p>Failed to access the webcam and microphone. Make sure to run this demo on an http server and click allow when asked for permission by the browser.</p>
        <a href="#" class="pure-button pure-button-error" id="step1-retry">Try again</a>
      </div>
    </div>

    <!-- Make calls to others -->
    <div id="step2">
      <p>Your id: <span id="my-id">...</span></p>
      <p>Share this id with others so they can call you.</p>
      <h3>Make a call</h3>
      <div class="pure-form">
        <input type="text" placeholder="Call user id..." id="callto-id">
        <a href="#" class="pure-button pure-button-success" id="make-call">Call</a>
      </div>
    </div>

    <!-- Call in progress -->
    <div id="step3">
      <p>Currently in call with <span id="their-id">...</span></p>
      <p><a href="#" class="pure-button pure-button-error" id="end-call">End call</a></p>
    </div>
  </div>
  </div>

  <script type="text/javascript">
    var audioctx = new AudioContext();

    var buffer = null;
    var src = null;
    var input = audioctx.createGain();
    var musics = document.getElementById("music");
    var selectedItem = "./cafe.mp3";

    input.connect(audioctx.destination);

    const LoadSample = (ctx, url) => {
      fetch(url).then(response => {
        return response.arrayBuffer();
      }).then(arrayBuffer => {
        ctx.decodeAudioData(arrayBuffer, (b) => {
          buffer = b;
        }, () => {});
        document.querySelector("button#playsound").removeAttribute("disabled");
      });
    }
    musics.onchange = function() {
      selectedItem = this.options[this.selectedIndex];
      console.log(selectedItem.value);
      LoadSample(audioctx, selectedItem.value);
    }
  </script>
  <script type="text/javascript">
    document.querySelector("button#playsound").addEventListener("click", (event) => {
      var label;
      if (event.target.innerHTML == "Stop") {
        src.stop(0);
        label = "Start";
      } else {
        src = audioctx.createBufferSource();
        src.buffer = buffer;
        src.loop = true;
        src.connect(input);
        src.start(0);
        label = "Stop";
      }
      event.target.innerHTML = label;
    });
  </script>

</body>

</html>
